<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}?v=1">
    <title>JUSTCODE | Online Judge</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/editor/editor.main.min.css">
    
    <style>
        body { background: #f3f4f6; color: #333; font-family: sans-serif; }
        .tag { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px; color: #475569; font-weight: bold; }
        .terminal { background: #1a1a1a; color: #10b981; padding: 15px; font-family: monospace; border-radius: 6px; margin-top: 20px; font-size: 13px; border-left: 4px solid #3b5998; }
        
        /* Markdown formatting */
        #p-desc h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1.5rem; border-bottom: 2px solid #3b5998; display: inline-block; }
        #p-desc h2 { font-size: 1.2rem; font-weight: bold; margin-top: 1.2rem; color: #3b5998; }
        #p-desc p { margin: 0.8rem 0; line-height: 1.6; }
        #p-desc code { background: #eee; padding: 2px 4px; border-radius: 4px; font-family: monospace; }

        /* Sample Test UI */
        .sample-test { border: 1px solid #b9b9b9; margin: 1rem 0; font-family: monospace; background: #fff; display: flex; flex-direction: column; }
        .sample-entry { display: flex; flex-direction: column; border-bottom: 2px solid #b9b9b9; }
        .sample-title { font-weight: bold; border-bottom: 1px solid #b9b9b9; padding: 4px 10px; background: #f8f8f8; font-size: 12px; text-transform: uppercase; }
        .sample-content { padding: 10px; background: #efefef; white-space: pre-wrap; font-size: 13px; color: #000; margin: 0; }

        #editor-main { height: 350px; border: 1px solid #ccc; }
        @media (min-width: 768px) { #editor-main { height: 500px; } }
    </style>
</head>
<body>
    <div class="max-w-[1000px] mx-auto bg-white min-h-screen border-x p-4 md:p-6 shadow-sm">
        <header class="flex flex-col md:flex-row justify-between border-b pb-4 mb-4 items-center gap-4 text-center md:text-left">
            <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                <img src="{{ url_for('static', filename='justcode.png') }}" class="w-10 h-10 md:w-12 md:h-12" alt="Logo">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black italic text-[#3b5998] tracking-tighter leading-none">JUSTCODE</h1>
                    <p class="text-[9px] md:text-[10px] text-gray-400 font-bold tracking-[0.2em] uppercase mt-1">Online Judge System</p>
                </div>
            </div>
            <div class="text-xs">
                User: <b>{{ session.username }}</b> <br>
                <a href="/logout" class="text-red-500 font-bold hover:underline">Logout</a>
            </div>
        </header>

        <nav class="flex gap-4 mb-6 border-b pb-2 text-sm font-bold overflow-x-auto whitespace-nowrap">
            <span onclick="goHome()" class="cursor-pointer text-blue-800 uppercase hover:text-blue-600">Problems</span>
            <span onclick="loadStatus()" class="cursor-pointer text-blue-800 uppercase hover:text-blue-600">Status</span>
            {% if is_admin %}
            <span onclick="openUserModal()" class="cursor-pointer text-purple-700 uppercase hover:text-purple-500">Users</span>
            {% endif %}
        </nav>

        <div id="v-list" class="overflow-x-auto">
            <table class="w-full border text-sm min-w-[500px]">
                <thead class="bg-gray-50">
                    <tr><th class="p-2 border w-12">#</th><th class="p-2 border text-left">Problem</th><th class="p-2 border text-left">Tags</th></tr>
                </thead>
                <tbody id="list-body"></tbody>
            </table>
        </div>

        <div id="v-detail" class="hidden">
            <div class="text-center mb-6">
                <h2 id="p-title" class="text-2xl md:text-3xl font-bold"></h2>
                <div id="p-tags" class="mt-2 flex flex-wrap justify-center"></div>
                <p id="p-tl" class="text-[10px] text-gray-500 font-bold mt-2 uppercase tracking-widest"></p>
            </div>
            <div id="p-desc" class="mb-8 border-t pt-4 text-sm px-1"></div>
            <div class="mb-2 flex justify-between items-end"><span class="text-xs font-bold text-gray-500 uppercase">Python Editor</span></div>
            <div id="editor-main"></div>
            <div id="terminal" class="terminal hidden">
                <div class="text-[10px] text-gray-500 mb-2 border-b border-gray-700 pb-1 uppercase font-bold">Verdict</div>
                <div id="term-out"></div>
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="submitCode()" class="w-full md:w-auto bg-[#3b5998] text-white px-10 py-4 font-bold rounded shadow hover:bg-blue-900 transition uppercase tracking-tighter">Submit Solution</button>
            </div>
        </div>

        <div id="v-status" class="hidden">
            <div class="flex justify-between items-center mb-2">
                <h2 class="font-bold text-lg uppercase">Recent Submissions</h2>
                {% if is_admin %}<button onclick="clearHistory()" class="text-[10px] bg-red-500 text-white px-2 py-1 rounded">CLEAR ALL</button>{% endif %}
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border text-center text-xs min-w-[500px]">
                    <thead class="bg-gray-100">
                        <tr><th class="p-2 border">User</th><th class="p-2 border">Problem</th><th class="p-2 border">Verdict</th><th class="p-2 border">Time</th></tr>
                    </thead>
                    <tbody id="status-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="m-user" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded shadow-xl w-full max-w-sm">
            <h2 class="font-bold border-b mb-4 pb-2 text-xl">Manage Users</h2>
            <div id="u-list" class="max-h-40 overflow-y-auto mb-4 border divide-y text-xs"></div>
            <div class="space-y-2">
                <input id="nu" placeholder="New Username" class="border p-2 text-sm w-full rounded">
                <input id="np" type="password" placeholder="Password" class="border p-2 text-sm w-full rounded">
                <div class="flex items-center gap-2 p-1">
                    <input type="checkbox" id="na" class="w-4 h-4">
                    <label for="na" class="text-xs font-bold text-gray-600">Admin</label>
                </div>
                <button onclick="saveUser()" class="bg-purple-600 text-white w-full py-2 rounded font-bold hover:bg-purple-700">ADD USER</button>
            </div>
            <button onclick="toggleModal('m-user', false)" class="mt-4 text-gray-400 text-xs w-full text-center hover:text-gray-600 underline">Close</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <script>
        let editor; let activePid = "";
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor-main'), { 
                language: 'python', theme: 'vs-dark', automaticLayout: true, minimap:{enabled:false}, fontSize: 14 
            });
            const path = window.location.pathname;
            if (path.startsWith('/problem/')) openProb(path.split('/')[2], false); else loadList();
        });

        function formatSampleTests(container) {
            const tables = container.querySelectorAll('table');
            tables.forEach(table => {
                const headers = Array.from(table.querySelectorAll('th')).map(h => h.innerText.toLowerCase().trim());
                if (headers.includes('input') && headers.includes('output')) {
                    const rows = table.querySelectorAll('tbody tr');
                    let html = '<div class="sample-test">';
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 2) {
                            html += `<div class="sample-entry"><div class="sample-title">Input</div><pre class="sample-content">${cells[0].innerText.trim()}</pre><div class="sample-title">Output</div><pre class="sample-content">${cells[1].innerText.trim()}</pre></div>`;
                        }
                    });
                    html += '</div>'; table.outerHTML = html;
                }
            });
        }

        async function loadList() {
            const res = await fetch('/api/problems-list');
            const data = await res.json();
            document.getElementById('list-body').innerHTML = data.map((p, i) => `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="openProb('${p.id}')">
                    <td class="border p-2 text-center text-gray-400 font-bold">${i+1}</td>
                    <td class="border p-2 font-bold text-blue-700 hover:underline">${p.title}</td>
                    <td class="border p-2">${p.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</td>
                </tr>`).join('');
            switchView('v-list');
        }

        async function openProb(id, push = true) {
            activePid = id;
            if (push) window.history.pushState({}, '', `/problem/${id}`);
            const res = await fetch(`/api/problem/${id}`);
            const p = await res.json();
            if (p.error) return goHome();
            document.getElementById('p-title').innerText = p.title;
            document.getElementById('p-tags').innerHTML = (p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
            document.getElementById('p-tl').innerText = `Time Limit: ${p.time_limit || 2.0}s`;
            const desc = document.getElementById('p-desc');
            desc.innerHTML = marked.parse(p.description || "");
            formatSampleTests(desc);
            if (window.MathJax) MathJax.typesetPromise([desc]);
            editor.setValue(p.template || "");
            switchView('v-detail');
            document.getElementById('terminal').classList.add('hidden');
        }

        async function submitCode() {
            const out = document.getElementById('term-out');
            document.getElementById('terminal').classList.remove('hidden');
            out.innerHTML = "<span class='animate-pulse text-blue-400 font-bold'>Running...</span>";
            const res = await fetch('/judge', { 
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({id:activePid, code:editor.getValue()}) 
            });
            const data = await res.json();
            let detailsHtml = (data.details || []).map(d => `
                <div class="flex justify-between border-b border-gray-800 py-1">
                    <span>Case #${d.test}</span><span class="font-bold ${d.status=='AC'?'text-emerald-400':'text-red-500'}">${d.status}</span>
                </div>`).join('');
            out.innerHTML = detailsHtml + `<div class="mt-4 text-lg font-bold">VERDICT: <span class="${data.verdict.includes('ACCEPTED')?'text-emerald-400':'text-red-500'}">${data.verdict}</span></div>`;
        }

        async function loadStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            document.getElementById('status-body').innerHTML = data.map(s => `
                <tr><td class="p-2 border font-bold">${s.u}</td><td class="p-2 border text-blue-600 cursor-pointer" onclick="openProb('${s.p}')">${s.p}</td><td class="p-2 border font-bold ${s.v.includes('AC')?'text-green-600':'text-red-600'}">${s.v}</td><td class="p-2 border text-gray-400">${s.t}</td></tr>`).join('');
            switchView('v-status');
        }

        async function openUserModal() {
            toggleModal('m-user', true);
            const res = await fetch('/api/users');
            const data = await res.json();
            document.getElementById('u-list').innerHTML = data.map(u => `
                <div class="p-2 flex justify-between items-center bg-gray-50 mb-1">
                    <div class="flex flex-col"><span class="font-bold">${u.username}</span>${u.is_admin ? '<span class="text-[8px] bg-purple-200 text-purple-700 px-1 rounded w-fit">ADMIN</span>' : ''}</div>
                    <button onclick="delUser(${u.id})" class="text-red-500 text-[10px] font-black uppercase hover:underline">Hapus</button>
                </div>`).join('');
        }

        async function saveUser() {
            const nu = document.getElementById('nu'), np = document.getElementById('np'), na = document.getElementById('na');
            if(!nu.value || !np.value) return alert("Isi username & pass!");
            await fetch('/api/users', { 
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({username:nu.value, password:np.value, is_admin:na.checked}) 
            });
            nu.value=''; np.value=''; na.checked=false; openUserModal();
        }

        async function delUser(id) { if(confirm("Hapus user?")) { await fetch(`/api/users?id=${id}`, {method:'DELETE'}); openUserModal(); } }
        async function clearHistory() { if(confirm("Hapus semua?")) { await fetch('/api/status', {method:'DELETE'}); loadStatus(); } }
        function goHome() { window.history.pushState({}, '', '/'); loadList(); }
        function switchView(v) { ['v-list','v-detail','v-status'].forEach(i=>document.getElementById(i).classList.add('hidden')); document.getElementById(v).classList.remove('hidden'); }
        function toggleModal(i, s) { document.getElementById(i).classList.toggle('hidden', !s); }
        window.onpopstate = () => location.reload();
    </script>
</body>
</html>